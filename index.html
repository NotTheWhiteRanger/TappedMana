<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tapped Mana - Commander Duel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .table {
            display: grid;
            grid-template-areas: 
                "opponent"
                "battlefield"
                "player";
            grid-template-rows: 1fr 2fr 1fr;
            height: 100vh;
            gap: 1px;
            background: #000;
        }

        .player {
            background: #2a2a2a;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #333;
        }

        .player.active {
            background: #2a3a2a;
            border-color: #4a7c59;
        }

        .opponent {
            grid-area: opponent;
            transform: rotate(180deg);
        }

        .your-turn {
            grid-area: player;
            position: relative;
        }

        .hand-display {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            height: 140px;
            background: rgba(42, 42, 42, 0.95);
            border: 1px solid #4a7c59;
            border-bottom: none;
            display: none;
            padding: 10px;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .hand-display.show {
            display: block;
        }

        .hand-cards {
            display: flex;
            gap: 8px;
            height: 100%;
            align-items: center;
        }

        .card {
            width: 80px;
            height: 112px;
            background: #333;
            border: 1px solid #555;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .card:hover {
            transform: translateY(-10px);
            border-color: #4a7c59;
            z-index: 10;
        }

        .card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 7px;
        }

        .card-back {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 50%, #8B4513 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFD700;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            line-height: 1.2;
        }

        .card-loading {
            width: 100%;
            height: 100%;
            background: #444;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 10px;
        }

        .card-search {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .search-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #4a7c59;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            background: #333;
            border: 1px solid #555;
            border-radius: 6px;
            color: #fff;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .search-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .search-card {
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .search-card:hover {
            transform: scale(1.05);
        }

        .search-card img {
            width: 100%;
            height: auto;
        }

        .close-search {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #4a7c59;
            cursor: pointer;
            font-size: 24px;
        }

        .hand-controls {
            position: absolute;
            top: -50px;
            right: 0;
            display: flex;
            gap: 8px;
        }

        .hand-btn {
            background: #4a7c59;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .hand-btn:hover {
            background: #5a8c69;
        }

        .card-preview {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 4000;
            display: none;
        }

        .card-preview img {
            max-width: 300px;
            max-height: 420px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .player-name {
            font-weight: 600;
            color: #fff;
            font-size: 16px;
        }

        .life {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 20px;
            min-width: 50px;
            text-align: center;
            cursor: pointer;
        }

        .life:hover {
            background: #c82333;
        }

        .commander-damage {
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
        }

        .zones {
            display: flex;
            gap: 12px;
        }

        .zone {
            background: #333;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-width: 60px;
        }

        .zone:hover {
            background: #3a3a3a;
            border-color: #555;
        }

        .zone-name {
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .zone-count {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }

        .battlefield {
            grid-area: battlefield;
            background: #222;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid #333;
        }

        .battlefield-content {
            text-align: center;
            color: #888;
        }

        .battlefield-title {
            font-size: 20px;
            margin-bottom: 24px;
            color: #ccc;
        }

        .stack {
            background: #2a2a2a;
            border: 1px dashed #555;
            border-radius: 8px;
            padding: 24px;
            margin: 24px 0;
            min-width: 250px;
        }

        .stack-title {
            font-size: 12px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .controls {
            position: absolute;
            bottom: 24px;
            left: 24px;
            display: flex;
            gap: 12px;
        }

        .btn {
            background: #4a7c59;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #5a8c69;
        }

        .btn.secondary {
            background: #555;
        }

        .btn.secondary:hover {
            background: #666;
        }

        .mana-pool {
            position: absolute;
            bottom: 24px;
            right: 24px;
            display: flex;
            gap: 6px;
        }

        .mana {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            transition: transform 0.1s;
        }

        .mana:hover {
            transform: scale(1.1);
        }

        .mana.w { background: #fffbd5; color: #000; }
        .mana.u { background: #0e68ab; color: #fff; }
        .mana.b { background: #150b00; color: #fff; }
        .mana.r { background: #d3202a; color: #fff; }
        .mana.g { background: #00733e; color: #fff; }

        .mana-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .turn-info {
            position: absolute;
            top: 24px;
            left: 24px;
            background: #2a2a2a;
            padding: 12px 20px;
            border-radius: 6px;
            border: 1px solid #4a7c59;
        }

        .turn-player {
            font-size: 16px;
            font-weight: 600;
            color: #4a7c59;
        }

        .phase {
            font-size: 12px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #2a2a2a;
            border: 1px solid #4a7c59;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .dice-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            perspective: 1200px;
        }

        .dice {
            width: 120px;
            height: 120px;
            position: relative;
            transform-style: preserve-3d;
            animation: roll 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .d20 {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 50%, #e0e0e0 100%);
            border-radius: 20%;
            position: relative;
            transform-style: preserve-3d;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
        }

        .d20:before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            right: 10%;
            bottom: 10%;
            background: radial-gradient(ellipse at 30% 30%, rgba(255, 255, 255, 0.6), transparent 60%);
            border-radius: 20%;
            pointer-events: none;
        }

        .dice-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: 900;
            color: #1a1a1a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            font-family: 'Arial Black', Arial, sans-serif;
            z-index: 1;
        }

        .dice-result {
            position: absolute;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #4a7c59, #5a8c69);
            color: white;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 36px;
            font-weight: bold;
            opacity: 0;
            animation: showResult 1s ease-out 2.5s forwards;
            box-shadow: 0 8px 25px rgba(74, 124, 89, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .dice-result:before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 15px solid #4a7c59;
        }

        @keyframes roll {
            0% {
                transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) translateY(0px);
            }
            15% {
                transform: rotateX(180deg) rotateY(270deg) rotateZ(90deg) translateY(-20px);
            }
            30% {
                transform: rotateX(360deg) rotateY(540deg) rotateZ(180deg) translateY(-10px);
            }
            45% {
                transform: rotateX(540deg) rotateY(270deg) rotateZ(270deg) translateY(-25px);
            }
            60% {
                transform: rotateX(720deg) rotateY(810deg) rotateZ(360deg) translateY(-5px);
            }
            75% {
                transform: rotateX(900deg) rotateY(540deg) rotateZ(450deg) translateY(-15px);
            }
            90% {
                transform: rotateX(1080deg) rotateY(1080deg) rotateZ(540deg) translateY(-2px);
            }
            100% {
                transform: rotateX(1080deg) rotateY(1080deg) rotateZ(540deg) translateY(0px);
            }
        }

        @keyframes showResult {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(30px) scale(0.8);
            }
            50% {
                transform: translateX(-50%) translateY(-10px) scale(1.1);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1);
            }
        }

        .roll-sound {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            animation: fadeInOut 2.5s ease-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .setup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .setup-content {
            background: #2a2a2a;
            padding: 48px;
            border-radius: 12px;
            border: 1px solid #4a7c59;
            text-align: center;
            max-width: 500px;
        }

        .setup h2 {
            color: #4a7c59;
            margin-bottom: 24px;
            font-size: 28px;
        }

        .setup p {
            color: #ccc;
            margin-bottom: 24px;
            line-height: 1.6;
            font-size: 16px;
        }

        .life-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .life-btn {
            background: #555;
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .life-btn:hover {
            background: #666;
        }

        @media (max-width: 768px) {
            .zones {
                gap: 8px;
            }
            
            .zone {
                min-width: 50px;
                padding: 6px 8px;
            }
            
            .controls, .mana-pool, .turn-info {
                position: static;
                margin: 16px;
            }
            
            .battlefield {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="table">
        <!-- Opponent -->
        <div class="player opponent" id="player2">
            <div class="player-info">
                <span class="player-name">Opponent</span>
                <div class="life-controls">
                    <button class="life-btn" onclick="changeLife(2, -1)">âˆ’</button>
                    <span class="life" onclick="editLife(2)">40</span>
                    <button class="life-btn" onclick="changeLife(2, 1)">+</button>
                </div>
                <div class="commander-damage" onclick="changeCommanderDamage(2)">CMD: 0</div>
            </div>
            <div class="zones">
                <div class="zone" onclick="zoneAction(2, 'library')">
                    <div class="zone-name">Library</div>
                    <div class="zone-count">99</div>
                </div>
                <div class="zone" onclick="zoneAction(2, 'hand')">
                    <div class="zone-name">Hand</div>
                    <div class="zone-count">7</div>
                </div>
                <div class="zone" onclick="zoneAction(2, 'graveyard')">
                    <div class="zone-name">Graveyard</div>
                    <div class="zone-count">0</div>
                </div>
                <div class="zone" onclick="zoneAction(2, 'exile')">
                    <div class="zone-name">Exile</div>
                    <div class="zone-count">0</div>
                </div>
            </div>
        </div>

        <!-- Battlefield -->
        <div class="battlefield">
            <div class="turn-info">
                <div class="turn-player" id="currentTurn">Your Turn</div>
                <div class="phase" id="currentPhase">Main Phase</div>
            </div>

            <div class="battlefield-content">
                <div class="battlefield-title">Battlefield</div>
                <div class="stack">
                    <div class="stack-title">The Stack</div>
                    <div style="color: #666; font-size: 14px;">Empty</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn" onclick="drawCard()">Draw Card</button>
                <button class="btn secondary" onclick="nextTurn()">End Turn</button>
                <button class="btn secondary" onclick="rollDice()">Roll D20</button>
            </div>

            <div class="mana-pool">
                <div class="mana w" onclick="addMana('w')" title="White Mana">
                    W<span class="mana-count" id="manaW">0</span>
                </div>
                <div class="mana u" onclick="addMana('u')" title="Blue Mana">
                    U<span class="mana-count" id="manaU">0</span>
                </div>
                <div class="mana b" onclick="addMana('b')" title="Black Mana">
                    B<span class="mana-count" id="manaB">0</span>
                </div>
                <div class="mana r" onclick="addMana('r')" title="Red Mana">
                    R<span class="mana-count" id="manaR">0</span>
                </div>
                <div class="mana g" onclick="addMana('g')" title="Green Mana">
                    G<span class="mana-count" id="manaG">0</span>
                </div>
            </div>
        </div>

        <!-- Your Turn -->
        <div class="player your-turn active" id="player1">
            <div class="hand-display" id="handDisplay">
                <div class="hand-controls">
                    <button class="hand-btn" onclick="addCardToHandFromSearch()">Add Card</button>
                    <button class="hand-btn" onclick="toggleHand()">Hide Hand</button>
                </div>
                <div class="hand-cards" id="handCards">
                    <!-- Cards will be populated here -->
                </div>
            </div>
            <div class="player-info">
                <span class="player-name">You</span>
                <div class="life-controls">
                    <button class="life-btn" onclick="changeLife(1, -1)">âˆ’</button>
                    <span class="life" onclick="editLife(1)">40</span>
                    <button class="life-btn" onclick="changeLife(1, 1)">+</button>
                </div>
                <div class="commander-damage" onclick="changeCommanderDamage(1)">CMD: 0</div>
            </div>
            <div class="zones">
                <div class="zone" onclick="zoneAction(1, 'library')">
                    <div class="zone-name">Library</div>
                    <div class="zone-count">99</div>
                </div>
                <div class="zone" onclick="toggleHand()">
                    <div class="zone-name">Hand</div>
                    <div class="zone-count">7</div>
                </div>
                <div class="zone" onclick="zoneAction(1, 'graveyard')">
                    <div class="zone-name">Graveyard</div>
                    <div class="zone-count">0</div>
                </div>
                <div class="zone" onclick="zoneAction(1, 'exile')">
                    <div class="zone-name">Exile</div>
                    <div class="zone-count">0</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-search" id="cardSearch">
        <div class="search-content">
            <button class="close-search" onclick="closeCardSearch()">&times;</button>
            <h3 style="color: #4a7c59; margin-bottom: 20px;">Search Cards</h3>
            <input type="text" class="search-input" id="searchInput" placeholder="Search for cards..." onkeyup="searchCards(event)">
            <div class="search-results" id="searchResults">
                <!-- Search results will appear here -->
            </div>
        </div>
    </div>

    <div class="card-preview" id="cardPreview">
        <img id="previewImage" src="" alt="Card Preview">
    </div>

    <div class="dice-container" id="diceContainer">
        <div class="dice" id="dice">
            <div class="d20">
                <div class="dice-number" id="diceNumber">20</div>
            </div>
            <div class="dice-result" id="diceResult">ðŸŽ² 20</div>
        </div>
        <div class="roll-sound">Rolling...</div>
    </div>

    <div class="setup" id="setup">
        <div class="setup-content">
            <h2>Commander Duel</h2>
            <p>Head-to-head Commander format. Each player starts with 40 life and a 99-card deck plus their Commander.</p>
            <p>First to deal 21 commander damage or reduce opponent to 0 life wins!</p>
            <button class="btn" onclick="startGame()">Start Duel</button>
        </div>
    </div>

    <script>
        let game = {
            currentPlayer: 1,
            phase: 'Main Phase',
            players: [
                null,
                { name: 'You', life: 40, library: 99, hand: 7, graveyard: 0, exile: 0, commanderDamage: 0 },
                { name: 'Opponent', life: 40, library: 99, hand: 7, graveyard: 0, exile: 0, commanderDamage: 0 }
            ],
            mana: { w: 0, u: 0, b: 0, r: 0, g: 0 },
            handCards: [],
            handVisible: false
        };

        // Scryfall API functions
        async function getRandomCard() {
            try {
                const response = await fetch('https://api.scryfall.com/cards/random');
                const card = await response.json();
                return card;
            } catch (error) {
                console.error('Error fetching random card:', error);
                return null;
            }
        }

        async function searchScryfallCards(query) {
            try {
                const response = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(query)}&unique=cards&order=name`);
                const data = await response.json();
                return data.data || [];
            } catch (error) {
                console.error('Error searching cards:', error);
                return [];
            }
        }

        // Hand management functions
        function toggleHand() {
            const handDisplay = document.getElementById('handDisplay');
            game.handVisible = !game.handVisible;
            
            if (game.handVisible) {
                handDisplay.classList.add('show');
                if (game.handCards.length === 0) {
                    populateStartingHand();
                }
            } else {
                handDisplay.classList.remove('show');
            }
        }

        async function populateStartingHand() {
            const handCardsContainer = document.getElementById('handCards');
            
            // Clear existing cards
            handCardsContainer.innerHTML = '';
            game.handCards = [];
            
            // Add loading indicators
            for (let i = 0; i < 7; i++) {
                const cardElement = createCardElement(null, true);
                handCardsContainer.appendChild(cardElement);
            }
            
            // Fetch 7 random cards
            for (let i = 0; i < 7; i++) {
                const card = await getRandomCard();
                if (card) {
                    game.handCards[i] = card;
                    updateCardElement(handCardsContainer.children[i], card);
                }
            }
        }

        function createCardElement(card = null, loading = false) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';
            
            if (loading) {
                cardDiv.innerHTML = '<div class="card-loading">Loading...</div>';
            } else if (card) {
                const img = document.createElement('img');
                img.src = card.image_uris?.small || card.image_uris?.normal || '';
                img.alt = card.name;
                img.onerror = () => {
                    cardDiv.innerHTML = '<div class="card-back">MTG<br>Card</div>';
                };
                cardDiv.appendChild(img);
                
                // Add click events
                cardDiv.addEventListener('click', () => showCardPreview(card));
                cardDiv.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    removeCardFromHand(card);
                });
            } else {
                cardDiv.innerHTML = '<div class="card-back">MTG<br>Card</div>';
            }
            
            return cardDiv;
        }

        function updateCardElement(cardElement, card) {
            const img = document.createElement('img');
            img.src = card.image_uris?.small || card.image_uris?.normal || '';
            img.alt = card.name;
            img.onerror = () => {
                cardElement.innerHTML = '<div class="card-back">MTG<br>Card</div>';
            };
            
            cardElement.innerHTML = '';
            cardElement.appendChild(img);
            
            // Add click events
            cardElement.addEventListener('click', () => showCardPreview(card));
            cardElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                removeCardFromHand(card);
            });
        }

        async function addCardToHand() {
            const card = await getRandomCard();
            if (card) {
                game.handCards.push(card);
                game.players[1].hand = game.handCards.length;
                
                const handCardsContainer = document.getElementById('handCards');
                const cardElement = createCardElement(card);
                handCardsContainer.appendChild(cardElement);
                
                updateDisplay();
                notify(`Drew: ${card.name}`);
            }
        }

        function removeCardFromHand(cardToRemove) {
            const index = game.handCards.findIndex(card => card.id === cardToRemove.id);
            if (index > -1) {
                game.handCards.splice(index, 1);
                game.players[1].hand = game.handCards.length;
                
                const handCardsContainer = document.getElementById('handCards');
                handCardsContainer.removeChild(handCardsContainer.children[index]);
                
                updateDisplay();
                notify(`Played: ${cardToRemove.name}`);
            }
        }

        function showCardPreview(card) {
            const preview = document.getElementById('cardPreview');
            const previewImage = document.getElementById('previewImage');
            
            previewImage.src = card.image_uris?.normal || card.image_uris?.large || '';
            previewImage.alt = card.name;
            
            preview.style.display = 'block';
            
            // Hide preview when clicking outside
            setTimeout(() => {
                document.addEventListener('click', hideCardPreview, { once: true });
            }, 100);
        }

        function hideCardPreview() {
            document.getElementById('cardPreview').style.display = 'none';
        }

        // Card search functions
        function addCardToHandFromSearch() {
            document.getElementById('cardSearch').style.display = 'flex';
        }

        function closeCardSearch() {
            document.getElementById('cardSearch').style.display = 'none';
        }

        let searchTimeout;
        async function searchCards(event) {
            clearTimeout(searchTimeout);
            const query = event.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                const results = await searchScryfallCards(query);
                displaySearchResults(results.slice(0, 20)); // Limit to 20 results
            }, 300);
        }

        function displaySearchResults(cards) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';
            
            cards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'search-card';
                
                const img = document.createElement('img');
                img.src = card.image_uris?.small || card.image_uris?.normal || '';
                img.alt = card.name;
                img.onerror = () => {
                    cardDiv.innerHTML = `<div style="padding: 10px; background: #333; color: #fff; text-align: center; font-size: 12px;">${card.name}</div>`;
                };
                
                cardDiv.appendChild(img);
                cardDiv.addEventListener('click', () => {
                    addSpecificCardToHand(card);
                    closeCardSearch();
                });
                
                resultsContainer.appendChild(cardDiv);
            });
        }

        function addSpecificCardToHand(card) {
            game.handCards.push(card);
            game.players[1].hand = game.handCards.length;
            
            if (game.handVisible) {
                const handCardsContainer = document.getElementById('handCards');
                const cardElement = createCardElement(card);
                handCardsContainer.appendChild(cardElement);
            }
            
            updateDisplay();
            notify(`Added: ${card.name}`);
        }

        function startGame() {
            document.getElementById('setup').style.display = 'none';
            // Show hand by default and populate with 7 cards
            setTimeout(() => {
                toggleHand();
            }, 500);
        }

        function zoneAction(player, zone) {
            const p = game.players[player];
            
            switch(zone) {
                case 'library':
                    if (p.library > 0) {
                        p.library--;
                        p.hand++;
                        if (player === 1) {
                            // Add a card to your visual hand
                            addCardToHand();
                        } else {
                            notify(`${p.name} drew a card`);
                        }
                    } else {
                        notify(`${p.name}'s library is empty!`);
                    }
                    break;
                case 'hand':
                    if (player === 1) {
                        toggleHand();
                    } else {
                        notify(`${p.name}: ${p.hand} cards in hand`);
                    }
                    break;
                case 'graveyard':
                    notify(`${p.name}: ${p.graveyard} cards in graveyard`);
                    break;
                case 'exile':
                    notify(`${p.name}: ${p.exile} cards in exile`);
                    break;
            }
            updateDisplay();
        }

        async function drawCard() {
            const p = game.players[game.currentPlayer];
            if (p.library > 0) {
                p.library--;
                p.hand++;
                
                if (game.currentPlayer === 1) {
                    // Add visual card to your hand
                    await addCardToHand();
                } else {
                    notify('Opponent drew a card');
                }
                
                updateDisplay();
            } else {
                notify('Library is empty!');
            }
        }

        // Update the addCardToHand function to not duplicate notifications
        async function addCardToHand() {
            const card = await getRandomCard();
            if (card) {
                game.handCards.push(card);
                game.players[1].hand = game.handCards.length;
                
                if (game.handVisible) {
                    const handCardsContainer = document.getElementById('handCards');
                    const cardElement = createCardElement(card);
                    handCardsContainer.appendChild(cardElement);
                }
                
                updateDisplay();
                // Only notify if called directly, not from draw functions
                if (!game.drawingCard) {
                    notify(`Drew: ${card.name}`);
                }
            }
        }

        // Fix the Add Card button to use search instead
        function addCardToHandFromSearch() {
            document.getElementById('cardSearch').style.display = 'flex';
            document.getElementById('searchInput').focus();
        }

        function changeLife(player, amount) {
            game.players[player].life += amount;
            updateDisplay();
            
            if (game.players[player].life <= 0) {
                notify(`${game.players[player].name} has been eliminated!`);
            }
        }

        function changeCommanderDamage(player) {
            const current = game.players[player].commanderDamage;
            const newValue = prompt(`Commander damage for ${game.players[player].name}:`, current);
            if (newValue !== null && !isNaN(newValue)) {
                game.players[player].commanderDamage = parseInt(newValue);
                updateDisplay();
                
                if (game.players[player].commanderDamage >= 21) {
                    notify(`${game.players[player].name} eliminated by commander damage!`);
                }
            }
        }

        async function drawCard() {
            const p = game.players[game.currentPlayer];
            if (p.library > 0) {
                p.library--;
                p.hand++;
                
                if (game.currentPlayer === 1) {
                    // Add visual card to your hand
                    game.drawingCard = true; // Flag to prevent duplicate notifications
                    const card = await getRandomCard();
                    if (card) {
                        game.handCards.push(card);
                        game.players[1].hand = game.handCards.length;
                        
                        if (game.handVisible) {
                            const handCardsContainer = document.getElementById('handCards');
                            const cardElement = createCardElement(card);
                            handCardsContainer.appendChild(cardElement);
                        }
                        
                        notify(`Drew: ${card.name}`);
                    }
                    game.drawingCard = false;
                } else {
                    notify('Opponent drew a card');
                }
                
                updateDisplay();
            } else {
                notify('Library is empty!');
            }
        }

        function nextTurn() {
            document.getElementById(`player${game.currentPlayer}`).classList.remove('active');
            game.currentPlayer = game.currentPlayer === 1 ? 2 : 1;
            document.getElementById(`player${game.currentPlayer}`).classList.add('active');
            
            const playerName = game.players[game.currentPlayer].name;
            document.getElementById('currentTurn').textContent = `${playerName}'s Turn`;
            
            // Clear mana pool
            for (let color in game.mana) {
                game.mana[color] = 0;
                document.getElementById(`mana${color.toUpperCase()}`).textContent = '0';
            }
            
            notify(`${playerName}'s turn begins`);
        }

        function rollDice() {
            const result = Math.floor(Math.random() * 20) + 1;
            
            // Show dice container
            const diceContainer = document.getElementById('diceContainer');
            const diceResult = document.getElementById('diceResult');
            const dice = document.getElementById('dice');
            const diceNumber = document.getElementById('diceNumber');
            
            // Reset animations
            dice.style.animation = 'none';
            diceResult.style.animation = 'none';
            diceResult.style.opacity = '0';
            
            // Show random numbers during roll
            let rollInterval;
            let rollCount = 0;
            
            // Set the final result
            diceResult.textContent = `ðŸŽ² ${result}`;
            
            // Show container
            diceContainer.style.display = 'flex';
            
            // Animate numbers changing during roll
            rollInterval = setInterval(() => {
                const randomNum = Math.floor(Math.random() * 20) + 1;
                diceNumber.textContent = randomNum;
                rollCount++;
                
                if (rollCount > 20) { // Stop after showing random numbers
                    clearInterval(rollInterval);
                    diceNumber.textContent = result; // Show final result
                }
            }, 100);
            
            // Start rolling animation
            setTimeout(() => {
                dice.style.animation = 'roll 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                diceResult.style.animation = 'showResult 1s ease-out 2.5s forwards';
            }, 10);
            
            // Hide after animation completes
            setTimeout(() => {
                diceContainer.style.display = 'none';
                clearInterval(rollInterval);
            }, 5000);
            
            // Add to notifications
            setTimeout(() => {
                notify(`Rolled: ${result}`);
            }, 4000);
        }

        function addMana(color) {
            game.mana[color]++;
            document.getElementById(`mana${color.toUpperCase()}`).textContent = game.mana[color];
            notify(`+1 ${color.toUpperCase()} mana`);
        }

        function updateDisplay() {
            for (let i = 1; i <= 2; i++) {
                const p = game.players[i];
                const el = document.getElementById(`player${i}`);
                
                el.querySelector('.life').textContent = p.life;
                el.querySelector('.commander-damage').textContent = `CMD: ${p.commanderDamage}`;
                
                const zones = el.querySelectorAll('.zone');
                zones[0].querySelector('.zone-count').textContent = p.library;
                zones[1].querySelector('.zone-count').textContent = p.hand;
                zones[2].querySelector('.zone-count').textContent = p.graveyard;
                zones[3].querySelector('.zone-count').textContent = p.exile;
            }
        }

        function notify(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 2500);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ') {
                e.preventDefault();
                drawCard();
            } else if (e.key === 'Enter') {
                nextTurn();
            } else if (e.key === 'r') {
                rollDice();
            } else if (e.key === 'h') {
                toggleHand();
            } else if (e.key === 'Escape') {
                hideCardPreview();
                closeCardSearch();
            }
        });

        // Click events for closing modals
        document.addEventListener('click', (e) => {
            // Close card preview when clicking outside
            if (e.target.id === 'cardPreview') {
                hideCardPreview();
            }
            // Close card search when clicking outside
            if (e.target.id === 'cardSearch') {
                closeCardSearch();
            }
        });
    </script>
</body>
</html>
