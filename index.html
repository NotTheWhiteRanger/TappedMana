<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tapped Mana - Commander Arena</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .game-container {
            display: grid;
            grid-template-rows: 120px 1fr 180px;
            height: 100vh;
            position: relative;
        }

        /* Opponent Area */
        .opponent-area {
            background: linear-gradient(180deg, rgba(30, 35, 50, 0.8) 0%, rgba(20, 25, 40, 0.4) 100%);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
        }

        .opponent-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4a90e2, #357abd);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            color: white;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .player-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .player-name {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }

        .life-total {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .life-number {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .life-number:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .commander-dmg {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .opponent-zones {
            display: flex;
            gap: 15px;
        }

        .zone-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
        }

        .zone-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(74, 144, 226, 0.5);
            transform: translateY(-2px);
        }

        .zone-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .zone-count {
            font-size: 20px;
            font-weight: bold;
            color: #ffffff;
        }

        /* Battlefield */
        .battlefield {
            background: radial-gradient(ellipse at center, rgba(30, 35, 50, 0.8) 0%, rgba(10, 14, 26, 0.9) 100%);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .battlefield-zones {
            display: grid;
            grid-template-rows: 1fr auto 1fr;
            height: 100%;
            padding: 20px;
            gap: 20px;
        }

        .opponent-battlefield, .player-battlefield {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            min-height: 100px;
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
        }

        .battlefield-center {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .stack-zone {
            background: rgba(255, 193, 7, 0.1);
            border: 2px dashed rgba(255, 193, 7, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            min-width: 200px;
        }

        .stack-title {
            color: rgba(255, 193, 7, 0.8);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stack-content {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
        }

        /* Game Controls */
        .game-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: rgba(74, 144, 226, 0.9);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #4a90e2;
            transform: translateY(-1px);
        }

        .control-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .control-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Turn Indicator */
        .turn-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(76, 175, 80, 0.9);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        /* Player Area */
        .player-area {
            background: linear-gradient(0deg, rgba(30, 35, 50, 0.9) 0%, rgba(20, 25, 40, 0.4) 100%);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
        }

        .player-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .player-zones {
            display: flex;
            gap: 15px;
        }

        /* Hand Display */
        .hand-area {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            height: 140px;
            background: linear-gradient(180deg, rgba(20, 25, 40, 0.95) 0%, rgba(30, 35, 50, 0.95) 100%);
            border-top: 2px solid rgba(74, 144, 226, 0.3);
            display: none;
            padding: 15px 20px;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .hand-area.visible {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .hand-controls {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            gap: 8px;
        }

        .hand-btn {
            background: rgba(74, 144, 226, 0.8);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .hand-btn:hover {
            background: #4a90e2;
        }

        .hand-cards {
            display: flex;
            gap: 8px;
            height: 100px;
            align-items: center;
            padding-top: 20px;
        }

        .mtg-card {
            width: 70px;
            height: 98px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            flex-shrink: 0;
            background: #2c3e50;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .mtg-card.playable {
            border-color: rgba(76, 175, 80, 0.8);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }

        .mtg-card.unplayable {
            border-color: rgba(244, 67, 54, 0.5);
            opacity: 0.6;
        }

        .mtg-card:hover {
            transform: translateY(-15px) scale(1.1);
            z-index: 10;
        }

        .mtg-card.playable:hover {
            border-color: rgba(76, 175, 80, 1);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.5);
        }

        .mtg-card.unplayable:hover {
            border-color: rgba(244, 67, 54, 0.8);
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3);
        }

        .mana-cost {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 10px;
            color: white;
            font-weight: bold;
            display: flex;
            gap: 1px;
        }

        .mana-symbol-small {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
        }

        .mana-symbol-small.w { background: #fffbd5; color: #333; }
        .mana-symbol-small.u { background: #0e68ab; color: #fff; }
        .mana-symbol-small.b { background: #2c1810; color: #fff; }
        .mana-symbol-small.r { background: #d3202a; color: #fff; }
        .mana-symbol-small.g { background: #00733e; color: #fff; }
        .mana-symbol-small.generic { background: #999; color: #fff; }

        .mtg-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .card-loading {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            text-align: center;
            border-radius: 6px;
        }

        /* Mana Pool */
        .mana-pool {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 6px;
        }

        .mana-symbol {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .mana-symbol:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .mana-w { background: #fffbd5; color: #333; }
        .mana-u { background: #0e68ab; color: #fff; }
        .mana-b { background: #2c1810; color: #fff; }
        .mana-r { background: #d3202a; color: #fff; }
        .mana-g { background: #00733e; color: #fff; }

        .mana-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Card Search Modal */
        .card-search-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .search-panel {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            border: 2px solid rgba(74, 144, 226, 0.3);
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-title {
            color: #4a90e2;
            font-size: 24px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .search-input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .search-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            flex: 1;
        }

        .search-result-card {
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
            background: #34495e;
        }

        .search-result-card:hover {
            transform: scale(1.05);
        }

        .search-result-card img {
            width: 100%;
            height: auto;
        }

        /* Card Preview */
        .card-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1500;
        }

        .card-preview-modal img {
            max-width: 400px;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
        }

        /* Dice Container */
        .dice-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .dice {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #ffffff, #f0f0f0);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            animation: rollDice 2s ease-out;
        }

        .dice-result-display {
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: #4a90e2;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 28px;
            font-weight: bold;
            opacity: 0;
            animation: showDiceResult 0.8s ease-out 2s forwards;
        }

        @keyframes rollDice {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            25% { transform: rotateX(180deg) rotateY(180deg); }
            50% { transform: rotateX(360deg) rotateY(360deg); }
            75% { transform: rotateX(540deg) rotateY(180deg); }
            100% { transform: rotateX(720deg) rotateY(360deg); }
        }

        @keyframes showDiceResult {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .opponent-area, .player-info {
                padding: 15px 20px;
            }
            
            .opponent-zones, .player-zones {
                gap: 10px;
            }
            
            .zone-card {
                min-width: 60px;
                padding: 8px;
            }
            
            .mtg-card {
                width: 60px;
                height: 84px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Opponent Area -->
        <div class="opponent-area">
            <div class="opponent-info">
                <div class="player-avatar">OP</div>
                <div class="player-stats">
                    <div class="player-name">Opponent</div>
                    <div class="life-total">
                        <div class="life-number" onclick="adjustLife(2, -1, 1)">40</div>
                        <div class="commander-dmg" onclick="adjustCommanderDamage(2)">CMD: 0</div>
                    </div>
                </div>
            </div>
            <div class="opponent-zones">
                <div class="zone-card" onclick="opponentZoneAction('library')">
                    <div class="zone-label">Library</div>
                    <div class="zone-count" id="opponentLibrary">99</div>
                </div>
                <div class="zone-card" onclick="opponentZoneAction('hand')">
                    <div class="zone-label">Hand</div>
                    <div class="zone-count" id="opponentHand">7</div>
                </div>
                <div class="zone-card" onclick="opponentZoneAction('graveyard')">
                    <div class="zone-label">Grave</div>
                    <div class="zone-count" id="opponentGrave">0</div>
                </div>
                <div class="zone-card" onclick="opponentZoneAction('exile')">
                    <div class="zone-label">Exile</div>
                    <div class="zone-count" id="opponentExile">0</div>
                </div>
            </div>
        </div>

        <!-- Battlefield -->
        <div class="battlefield">
            <div class="turn-indicator" id="turnIndicator">Your Turn - Main Phase</div>
            
            <div class="game-controls">
                <button class="control-btn" onclick="drawCard()">Draw</button>
                <button class="control-btn secondary" onclick="endTurn()">End Turn</button>
                <button class="control-btn secondary" onclick="rollD20()">Roll D20</button>
            </div>

            <div class="battlefield-zones">
                <div class="opponent-battlefield" id="opponentBattlefield">
                    <div style="color: rgba(255,255,255,0.4); font-size: 14px;">Opponent's Battlefield</div>
                </div>

                <div class="battlefield-center">
                    <div class="stack-zone">
                        <div class="stack-title">THE STACK</div>
                        <div class="stack-content">Empty</div>
                    </div>
                </div>

                <div class="player-battlefield" id="playerBattlefield">
                    <div style="color: rgba(255,255,255,0.4); font-size: 14px;">Your Battlefield</div>
                </div>
            </div>

            <div class="mana-pool">
                <div class="mana-symbol mana-w" onclick="addMana('W')">
                    W<span class="mana-count" id="manaW">0</span>
                </div>
                <div class="mana-symbol mana-u" onclick="addMana('U')">
                    U<span class="mana-count" id="manaU">0</span>
                </div>
                <div class="mana-symbol mana-b" onclick="addMana('B')">
                    B<span class="mana-count" id="manaB">0</span>
                </div>
                <div class="mana-symbol mana-r" onclick="addMana('R')">
                    R<span class="mana-count" id="manaR">0</span>
                </div>
                <div class="mana-symbol mana-g" onclick="addMana('G')">
                    G<span class="mana-count" id="manaG">0</span>
                </div>
                <div class="mana-symbol" style="background: #999; color: #fff;" onclick="addMana('C')">
                    C<span class="mana-count" id="manaC">0</span>
                </div>
            </div>
        </div>

        <!-- Player Area -->
        <div class="player-area">
            <div class="hand-area" id="handArea">
                <div class="hand-controls">
                    <button class="hand-btn" onclick="showCardSearch()">Add Card</button>
                    <button class="hand-btn" onclick="toggleHand()">Hide</button>
                </div>
                <div class="hand-cards" id="handCards">
                    <!-- Cards populated here -->
                </div>
            </div>

            <div class="player-info">
                <div class="player-left">
                    <div class="player-avatar">YOU</div>
                    <div class="player-stats">
                        <div class="player-name">You</div>
                        <div class="life-total">
                            <div class="life-number" onclick="adjustLife(1, -1, 1)" id="playerLife">40</div>
                            <div class="commander-dmg" onclick="adjustCommanderDamage(1)" id="playerCmd">CMD: 0</div>
                        </div>
                    </div>
                </div>
                <div class="player-zones">
                    <div class="zone-card" onclick="playerZoneAction('library')">
                        <div class="zone-label">Library</div>
                        <div class="zone-count" id="playerLibrary">99</div>
                    </div>
                    <div class="zone-card" onclick="toggleHand()">
                        <div class="zone-label">Hand</div>
                        <div class="zone-count" id="playerHandCount">7</div>
                    </div>
                    <div class="zone-card" onclick="playerZoneAction('graveyard')">
                        <div class="zone-label">Grave</div>
                        <div class="zone-count" id="playerGrave">0</div>
                    </div>
                    <div class="zone-card" onclick="playerZoneAction('exile')">
                        <div class="zone-label">Exile</div>
                        <div class="zone-count" id="playerExile">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Search Modal -->
    <div class="card-search-modal" id="cardSearchModal">
        <div class="search-panel">
            <div class="search-header">
                <div class="search-title">Search Cards</div>
                <button class="close-btn" onclick="closeCardSearch()">&times;</button>
            </div>
            <input type="text" class="search-input" id="searchInput" placeholder="Search for Magic cards..." onkeyup="searchCards(event)">
            <div class="search-results" id="searchResults"></div>
        </div>
    </div>

    <!-- Card Preview Modal -->
    <div class="card-preview-modal" id="cardPreviewModal" onclick="closeCardPreview()">
        <img id="cardPreviewImg" src="" alt="Card Preview">
    </div>

    <!-- Dice Modal -->
    <div class="dice-modal" id="diceModal">
        <div class="dice" id="dice">
            <div class="dice-result-display" id="diceResultDisplay">20</div>
            <span id="diceNumber">20</span>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            currentPlayer: 1, // 1 = You, 2 = Opponent
            phase: 'Main Phase',
            turn: 1,
            landsPlayedThisTurn: 0,
            players: {
                1: { life: 40, library: 99, hand: 7, graveyard: 0, exile: 0, commanderDamage: 0 },
                2: { life: 40, library: 99, hand: 7, graveyard: 0, exile: 0, commanderDamage: 0 }
            },
            mana: { W: 0, U: 0, B: 0, R: 0, G: 0, C: 0 }, // Added colorless
            handCards: [],
            handVisible: false,
            battlefield: {
                1: [], // Player's battlefield
                2: []  // Opponent's battlefield
            }
        };

        // Mana System
        function parseManaSymbols(manaCost) {
            if (!manaCost) return [];
            
            // Remove outer braces and split by individual mana symbols
            const symbols = manaCost.match(/\{[^}]+\}/g) || [];
            return symbols.map(symbol => {
                const inner = symbol.slice(1, -1); // Remove { }
                if (/^\d+$/.test(inner)) return { type: 'generic', amount: parseInt(inner) };
                if (inner === 'W') return { type: 'W', amount: 1 };
                if (inner === 'U') return { type: 'U', amount: 1 };
                if (inner === 'B') return { type: 'B', amount: 1 };
                if (inner === 'R') return { type: 'R', amount: 1 };
                if (inner === 'G') return { type: 'G', amount: 1 };
                if (inner === 'C') return { type: 'C', amount: 1 };
                // Handle hybrid mana later if needed
                return { type: 'generic', amount: 1 };
            });
        }

        function calculateManaCost(card) {
            if (!card.mana_cost) return { total: 0, specific: {} };
            
            const symbols = parseManaSymbols(card.mana_cost);
            const cost = { total: 0, specific: { W: 0, U: 0, B: 0, R: 0, G: 0, C: 0 } };
            
            symbols.forEach(symbol => {
                if (symbol.type === 'generic') {
                    cost.total += symbol.amount;
                } else {
                    cost.specific[symbol.type] += symbol.amount;
                    cost.total += symbol.amount;
                }
            });
            
            return cost;
        }

        function canAffordCard(card) {
            const cost = calculateManaCost(card);
            const manaPool = gameState.mana;
            
            // Check specific color requirements
            for (let color of ['W', 'U', 'B', 'R', 'G', 'C']) {
                if (cost.specific[color] > manaPool[color]) {
                    return false;
                }
            }
            
            // Check total mana including generic costs
            const availableTotal = Object.values(manaPool).reduce((sum, amount) => sum + amount, 0);
            const requiredTotal = cost.total;
            
            return availableTotal >= requiredTotal;
        }

        function payManaCost(card) {
            const cost = calculateManaCost(card);
            const manaPool = { ...gameState.mana };
            
            // Pay specific color costs first
            for (let color of ['W', 'U', 'B', 'R', 'G', 'C']) {
                if (cost.specific[color] > 0) {
                    manaPool[color] -= cost.specific[color];
                }
            }
            
            // Pay generic costs with remaining mana
            let genericCostRemaining = cost.total - Object.values(cost.specific).reduce((sum, amount) => sum + amount, 0);
            
            for (let color of ['W', 'U', 'B', 'R', 'G', 'C']) {
                while (genericCostRemaining > 0 && manaPool[color] > 0) {
                    manaPool[color]--;
                    genericCostRemaining--;
                }
            }
            
            // Update actual mana pool
            gameState.mana = manaPool;
            updateManaDisplay();
        }

        function isLand(card) {
            return card.type_line && card.type_line.toLowerCase().includes('land');
        }

        function isCreature(card) {
            return card.type_line && card.type_line.toLowerCase().includes('creature');
        }

        function isInstant(card) {
            return card.type_line && card.type_line.toLowerCase().includes('instant');
        }

        function isSorcery(card) {
            return card.type_line && card.type_line.toLowerCase().includes('sorcery');
        }

        function canPlayCard(card) {
            // Check if it's a land
            if (isLand(card)) {
                return gameState.landsPlayedThisTurn < 1 && gameState.phase === 'Main Phase';
            }
            
            // Check if it's an instant (can play anytime)
            if (isInstant(card)) {
                return canAffordCard(card);
            }
            
            // Other spells can only be played in main phase
            if (gameState.phase !== 'Main Phase') {
                return false;
            }
            
            return canAffordCard(card);
        }

        // Scryfall API functions
        async function getRandomCard() {
            try {
                const response = await fetch('https://api.scryfall.com/cards/random');
                if (!response.ok) throw new Error('Failed to fetch');
                return await response.json();
            } catch (error) {
                console.error('Error fetching card:', error);
                return null;
            }
        }

        async function searchScryfallCards(query) {
            if (query.length < 2) return [];
            try {
                const response = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(query)}&order=name`);
                if (!response.ok) return [];
                const data = await response.json();
                return data.data?.slice(0, 20) || [];
            } catch (error) {
                console.error('Search error:', error);
                return [];
            }
        }

        // Hand Management
        async function populateStartingHand() {
            const handContainer = document.getElementById('handCards');
            handContainer.innerHTML = '';
            gameState.handCards = [];

            // Show loading cards
            for (let i = 0; i < 7; i++) {
                const cardEl = document.createElement('div');
                cardEl.className = 'mtg-card';
                cardEl.innerHTML = '<div class="card-loading">Loading...</div>';
                handContainer.appendChild(cardEl);
            }

            // Fetch real cards
            for (let i = 0; i < 7; i++) {
                const card = await getRandomCard();
                if (card) {
                    gameState.handCards[i] = card;
                    updateCardElement(handContainer.children[i], card);
                }
            }
        }

        function updateCardElement(element, card) {
            element.innerHTML = '';
            const img = document.createElement('img');
            img.src = card.image_uris?.small || card.image_uris?.normal || '';
            img.alt = card.name;
            img.onerror = () => {
                element.innerHTML = '<div class="card-loading">Failed</div>';
            };
            element.appendChild(img);
            
            // Add mana cost display
            if (card.mana_cost) {
                const manaCostEl = document.createElement('div');
                manaCostEl.className = 'mana-cost';
                
                const symbols = parseManaSymbols(card.mana_cost);
                symbols.forEach(symbol => {
                    const symbolEl = document.createElement('span');
                    symbolEl.className = `mana-symbol-small ${symbol.type.toLowerCase()}`;
                    if (symbol.type === 'generic') {
                        symbolEl.textContent = symbol.amount;
                    } else {
                        symbolEl.textContent = symbol.type;
                    }
                    manaCostEl.appendChild(symbolEl);
                });
                
                element.appendChild(manaCostEl);
            }
            
            // Update playability
            updateCardPlayability(element, card);
            
            element.onclick = () => showCardPreview(card);
            element.oncontextmenu = (e) => {
                e.preventDefault();
                if (canPlayCard(card)) {
                    playCard(card);
                } else {
                    showNotification(`Cannot play ${card.name} - ${getUnplayableReason(card)}`);
                }
            };
        }

        function updateCardPlayability(element, card) {
            element.classList.remove('playable', 'unplayable');
            
            if (canPlayCard(card)) {
                element.classList.add('playable');
                element.title = `Right-click to play ${card.name}`;
            } else {
                element.classList.add('unplayable');
                element.title = `Cannot play: ${getUnplayableReason(card)}`;
            }
        }

        function getUnplayableReason(card) {
            if (isLand(card)) {
                if (gameState.landsPlayedThisTurn >= 1) {
                    return "Already played a land this turn";
                }
                if (gameState.phase !== 'Main Phase') {
                    return "Can only play lands in main phase";
                }
            }
            
            if (!isInstant(card) && gameState.phase !== 'Main Phase') {
                return "Can only play in main phase";
            }
            
            if (!canAffordCard(card)) {
                const cost = calculateManaCost(card);
                return `Need ${cost.total} mana`;
            }
            
            return "Cannot play";
        }

        function playCard(card) {
            const index = gameState.handCards.findIndex(c => c.id === card.id);
            if (index === -1) return;
            
            // Handle land
            if (isLand(card)) {
                // Add land to battlefield and add mana
                addLandToBattlefield(card);
                gameState.landsPlayedThisTurn++;
            } else {
                // Pay mana cost
                payManaCost(card);
                
                // Move card to appropriate zone
                if (isCreature(card)) {
                    addCreatureToBattlefield(card);
                } else {
                    // Instants and sorceries go to graveyard after resolving
                    gameState.players[1].graveyard++;
                    showNotification(`${card.name} resolved`);
                }
            }
            
            // Remove from hand
            gameState.handCards.splice(index, 1);
            gameState.players[1].hand = gameState.handCards.length;
            
            const handContainer = document.getElementById('handCards');
            handContainer.removeChild(handContainer.children[index]);
            
            updateDisplay();
            updateAllCardPlayability();
        }

        function addLandToBattlefield(land) {
            gameState.battlefield[1].push(land);
            
            // Add mana based on land type (simplified)
            const landName = land.name.toLowerCase();
            if (landName.includes('plains') || landName.includes('plain')) {
                gameState.mana.W++;
            } else if (landName.includes('island')) {
                gameState.mana.U++;
            } else if (landName.includes('swamp')) {
                gameState.mana.B++;
            } else if (landName.includes('mountain')) {
                gameState.mana.R++;
            } else if (landName.includes('forest')) {
                gameState.mana.G++;
            } else {
                // Generic land adds colorless mana
                gameState.mana.C++;
            }
            
            updateManaDisplay();
            showNotification(`Played ${land.name}`);
        }

        function addCreatureToBattlefield(creature) {
            gameState.battlefield[1].push(creature);
            showNotification(`${creature.name} enters the battlefield`);
            // TODO: Add visual creature to battlefield
        }

        function updateAllCardPlayability() {
            const handContainer = document.getElementById('handCards');
            Array.from(handContainer.children).forEach((cardEl, index) => {
                if (gameState.handCards[index]) {
                    updateCardPlayability(cardEl, gameState.handCards[index]);
                }
            });
        }

        function updateManaDisplay() {
            Object.keys(gameState.mana).forEach(color => {
                const element = document.getElementById(`mana${color}`);
                if (element) {
                    element.textContent = gameState.mana[color];
                }
            });
        }

        function toggleHand() {
            const handArea = document.getElementById('handArea');
            gameState.handVisible = !gameState.handVisible;
            
            if (gameState.handVisible) {
                handArea.classList.add('visible');
                if (gameState.handCards.length === 0) {
                    populateStartingHand();
                }
            } else {
                handArea.classList.remove('visible');
            }
        }

        async function drawCard() {
            if (gameState.players[1].library <= 0) {
                showNotification('Library is empty!');
                return;
            }

            gameState.players[1].library--;
            gameState.players[1].hand++;
            
            const card = await getRandomCard();
            if (card) {
                gameState.handCards.push(card);
                
                if (gameState.handVisible) {
                    const handContainer = document.getElementById('handCards');
                    const cardEl = document.createElement('div');
                    cardEl.className = 'mtg-card';
                    updateCardElement(cardEl, card);
                    handContainer.appendChild(cardEl);
                }
                
                showNotification(`Drew: ${card.name}`);
            }
            
            updateDisplay();
        }

        function removeCardFromHand(card) {
            const index = gameState.handCards.findIndex(c => c.id === card.id);
            if (index > -1) {
                gameState.handCards.splice(index, 1);
                gameState.players[1].hand = gameState.handCards.length;
                
                const handContainer = document.getElementById('handCards');
                handContainer.removeChild(handContainer.children[index]);
                
                showNotification(`Played: ${card.name}`);
                updateDisplay();
            }
        }

        // Card Search
        function showCardSearch() {
            document.getElementById('cardSearchModal').style.display = 'flex';
            document.getElementById('searchInput').focus();
        }

        function closeCardSearch() {
            document.getElementById('cardSearchModal').style.display = 'none';
        }

        let searchTimeout;
        async function searchCards(event) {
            clearTimeout(searchTimeout);
            const query = event.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                const results = await searchScryfallCards(query);
                displaySearchResults(results);
            }, 300);
        }

        function displaySearchResults(cards) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            
            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'search-result-card';
                
                const img = document.createElement('img');
                img.src = card.image_uris?.small || '';
                img.alt = card.name;
                cardEl.appendChild(img);
                
                cardEl.onclick = () => {
                    addCardToHand(card);
                    closeCardSearch();
                };
                
                container.appendChild(cardEl);
            });
        }

        function addCardToHand(card) {
            gameState.handCards.push(card);
            gameState.players[1].hand = gameState.handCards.length;
            
            if (gameState.handVisible) {
                const handContainer = document.getElementById('handCards');
                const cardEl = document.createElement('div');
                cardEl.className = 'mtg-card';
                updateCardElement(cardEl, card);
                handContainer.appendChild(cardEl);
            }
            
            showNotification(`Added: ${card.name}`);
            updateDisplay();
        }

        // Card Preview
        function showCardPreview(card) {
            const modal = document.getElementById('cardPreviewModal');
            const img = document.getElementById('cardPreviewImg');
            img.src = card.image_uris?.normal || card.image_uris?.large || '';
            modal.style.display = 'flex';
        }

        function closeCardPreview() {
            document.getElementById('cardPreviewModal').style.display = 'none';
        }

        // Game Actions
        function adjustLife(player, amount, clicks) {
            gameState.players[player].life += amount * clicks;
            updateDisplay();
        }

        function addMana(color) {
            gameState.mana[color]++;
            document.getElementById(`mana${color}`).textContent = gameState.mana[color];
            showNotification(`+1 ${color} mana`);
        }

        function endTurn() {
            gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
            
            // Clear mana pool
            Object.keys(gameState.mana).forEach(color => {
                gameState.mana[color] = 0;
                document.getElementById(`mana${color}`).textContent = '0';
            });
            
            const playerName = gameState.currentPlayer === 1 ? 'Your' : "Opponent's";
            document.getElementById('turnIndicator').textContent = `${playerName} Turn - Main Phase`;
            showNotification(`${playerName} turn begins`);
        }

        function rollD20() {
            const result = Math.floor(Math.random() * 20) + 1;
            const modal = document.getElementById('diceModal');
            const diceNum = document.getElementById('diceNumber');
            const resultDisplay = document.getElementById('diceResultDisplay');
            
            modal.style.display = 'flex';
            resultDisplay.textContent = `🎲 ${result}`;
            
            // Animate numbers during roll
            let count = 0;
            const interval = setInterval(() => {
                diceNum.textContent = Math.floor(Math.random() * 20) + 1;
                count++;
                if (count > 15) {
                    clearInterval(interval);
                    diceNum.textContent = result;
                }
            }, 100);
            
            setTimeout(() => {
                modal.style.display = 'none';
                showNotification(`Rolled: ${result}`);
            }, 4000);
        }

        // Zone Actions
        function playerZoneAction(zone) {
            const player = gameState.players[1];
            switch(zone) {
                case 'library':
                    drawCard();
                    break;
                case 'graveyard':
                    showNotification(`Graveyard: ${player.graveyard} cards`);
                    break;
                case 'exile':
                    showNotification(`Exile: ${player.exile} cards`);
                    break;
            }
        }

        function opponentZoneAction(zone) {
            const player = gameState.players[2];
            switch(zone) {
                case 'library':
                    if (player.library > 0) {
                        player.library--;
                        player.hand++;
                        showNotification('Opponent drew a card');
                        updateDisplay();
                    }
                    break;
                case 'hand':
                    showNotification(`Opponent: ${player.hand} cards in hand`);
                    break;
                case 'graveyard':
                    showNotification(`Opponent graveyard: ${player.graveyard} cards`);
                    break;
                case 'exile':
                    showNotification(`Opponent exile: ${player.exile} cards`);
                    break;
            }
        }

        // Display Updates
        function updateDisplay() {
            // Player stats
            document.getElementById('playerLife').textContent = gameState.players[1].life;
            document.getElementById('playerLibrary').textContent = gameState.players[1].library;
            document.getElementById('playerHandCount').textContent = gameState.players[1].hand;
            document.getElementById('playerGrave').textContent = gameState.players[1].graveyard;
            document.getElementById('playerExile').textContent = gameState.players[1].exile;
            
            // Opponent stats
            document.querySelector('.opponent-area .life-number').textContent = gameState.players[2].life;
            document.getElementById('opponentLibrary').textContent = gameState.players[2].library;
            document.getElementById('opponentHand').textContent = gameState.players[2].hand;
            document.getElementById('opponentGrave').textContent = gameState.players[2].graveyard;
            document.getElementById('opponentExile').textContent = gameState.players[2].exile;
        }

        function showNotification(message) {
            // Create floating notification with better styling
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, rgba(74, 144, 226, 0.95), rgba(53, 122, 189, 0.95));
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                font-weight: 500;
                z-index: 1000;
                animation: fadeInOut 4s ease-out forwards;
                border: 1px solid rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                max-width: 300px;
                word-wrap: break-word;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 4000);
        }

        // Enhanced mana system for better land detection
        function addLandToBattlefield(land) {
            gameState.battlefield[1].push(land);
            
            // More comprehensive land mana detection
            const landName = land.name.toLowerCase();
            const oracle = (land.oracle_text || '').toLowerCase();
            
            // Basic lands
            if (landName.includes('plains') || oracle.includes('add {w}')) {
                gameState.mana.W++;
                showNotification(`${land.name} - Added 1 White mana`);
            } else if (landName.includes('island') || oracle.includes('add {u}')) {
                gameState.mana.U++;
                showNotification(`${land.name} - Added 1 Blue mana`);
            } else if (landName.includes('swamp') || oracle.includes('add {b}')) {
                gameState.mana.B++;
                showNotification(`${land.name} - Added 1 Black mana`);
            } else if (landName.includes('mountain') || oracle.includes('add {r}')) {
                gameState.mana.R++;
                showNotification(`${land.name} - Added 1 Red mana`);
            } else if (landName.includes('forest') || oracle.includes('add {g}')) {
                gameState.mana.G++;
                showNotification(`${land.name} - Added 1 Green mana`);
            } else {
                // Default to colorless for unknown lands
                gameState.mana.C++;
                showNotification(`${land.name} - Added 1 Colorless mana`);
            }
            
            updateManaDisplay();
        }

        // Better card type detection
        function getCardTypeInfo(card) {
            const typeLine = (card.type_line || '').toLowerCase();
            const cmc = card.cmc || 0;
            
            return {
                isLand: typeLine.includes('land'),
                isCreature: typeLine.includes('creature'),
                isInstant: typeLine.includes('instant'),
                isSorcery: typeLine.includes('sorcery'),
                isArtifact: typeLine.includes('artifact'),
                isEnchantment: typeLine.includes('enchantment'),
                isPlaneswalker: typeLine.includes('planeswalker'),
                cmc: cmc
            };
        }

        // Update the instruction text to be more helpful
        function updateInstructions() {
            const instructionText = `
                Controls:
                • Click cards to preview
                • Right-click to play/cast
                • Green border = playable
                • Red border = can't play
                • Space = Draw card
                • H = Toggle hand
                • Enter = End turn
            `;
            
            // You could add this to a help system later
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            
            switch(e.key.toLowerCase()) {
                case ' ':
                    e.preventDefault();
                    drawCard();
                    break;
                case 'h':
                    toggleHand();
                    break;
                case 'enter':
                    endTurn();
                    break;
                case 'r':
                    rollD20();
                    break;
                case 'escape':
                    closeCardPreview();
                    closeCardSearch();
                    break;
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateDisplay();
            updateManaDisplay();
            // Auto-show hand on start
            setTimeout(() => {
                toggleHand();
                showNotification('Welcome! Right-click cards to play them. Lands give mana, spells cost mana.');
            }, 1000);
        });

        // Add CSS animation for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateX(20px); }
                15%, 85% { opacity: 1; transform: translateX(0); }
                100% { opacity: 0; transform: translateX(20px); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
