<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Commander Game</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide-react/0.263.1/lucide-react.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-auth-compat.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom animations and styles */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(147, 51, 234, 0.5); }
            50% { box-shadow: 0 0 30px rgba(147, 51, 234, 0.8); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        .float {
            animation: float 3s ease-in-out infinite;
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .mana-symbol {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
        }
        
        .mana-w { background: #fffbd5; border: 2px solid #0d1b2a; }
        .mana-u { background: #0e68ab; }
        .mana-b { background: #150b00; }
        .mana-r { background: #d3202a; }
        .mana-g { background: #00733e; }
        .mana-c { background: #ccc2c0; }
        
        /* Life counter styling */
        .life-counter {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .life-counter::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s linear infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        /* Commander damage tracking */
        .commander-damage {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            border-radius: 10px;
            padding: 8px;
            margin: 2px;
            color: white;
            font-weight: bold;
            text-align: center;
        }
        
        /* Game board layout */
        .game-board {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            grid-template-rows: 1fr 2fr 1fr;
            gap: 20px;
            height: 100vh;
            padding: 20px;
        }
        
        .player-zone {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .central-zone {
            grid-column: 2;
            grid-row: 2;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCWtqzh5k15SuU7BeY1p_2tK5YAMN8q3g4",
            authDomain: "tappedmana-aaf06.firebaseapp.com",
            databaseURL: "https://tappedmana-aaf06-default-rtdb.firebaseio.com",
            projectId: "tappedmana-aaf06",
            storageBucket: "tappedmana-aaf06.firebasestorage.app",
            messagingSenderId: "667667024247",
            appId: "1:667667024247:web:fee2e63bdd380682d5b972"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Import React hooks
        const { useState, useEffect, useCallback, useRef } = React;
        const { 
            Users, Plus, Minus, Heart, Shield, Zap, Search, Filter, Play, Settings, 
            Sword, Crown, Sparkles, Target, Shuffle, Eye, ChevronRight, Home, Copy, 
            Wifi, WifiOff, RefreshCw, LogOut, Dice6, RotateCcw, Timer, Star 
        } = lucide;

        // Enhanced Scryfall API service
        class ScryfallService {
            static BASE_URL = 'https://api.scryfall.com';
            static cache = new Map();

            static async searchCards(query, page = 1, options = {}) {
                const cacheKey = `search_${query}_${page}`;
                if (this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }

                try {
                    let searchQuery = query;
                    if (options.commander) searchQuery += ' is:commander';
                    if (options.format) searchQuery += ` legal:${options.format}`;
                    if (options.colors) searchQuery += ` color:${options.colors}`;
                    
                    const response = await fetch(
                        `${this.BASE_URL}/cards/search?q=${encodeURIComponent(searchQuery)}&page=${page}&order=edhrec`
                    );
                    
                    if (!response.ok) {
                        if (response.status === 404) return { data: [], total_cards: 0 };
                        throw new Error('Failed to fetch cards');
                    }
                    
                    const result = await response.json();
                    this.cache.set(cacheKey, result);
                    return result;
                } catch (error) {
                    console.error('Scryfall API error:', error);
                    return { data: [], total_cards: 0 };
                }
            }

            static async getRandomCard(options = {}) {
                try {
                    let url = `${this.BASE_URL}/cards/random`;
                    const params = new URLSearchParams();
                    
                    if (options.commander) params.append('q', 'is:commander');
                    if (options.format) params.append('q', `legal:${options.format}`);
                    
                    if (params.toString()) url += `?${params.toString()}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Failed to fetch random card');
                    return response.json();
                } catch (error) {
                    console.error('Scryfall API error:', error);
                    return null;
                }
            }

            static async getCardByName(name) {
                const cacheKey = `card_${name}`;
                if (this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }

                try {
                    const response = await fetch(`${this.BASE_URL}/cards/named?exact=${encodeURIComponent(name)}`);
                    if (!response.ok) throw new Error('Card not found');
                    const result = await response.json();
                    this.cache.set(cacheKey, result);
                    return result;
                } catch (error) {
                    console.error('Scryfall API error:', error);
                    return null;
                }
            }

            static parseManaCost(manaCost) {
                if (!manaCost) return [];
                return manaCost.match(/{[^}]+}/g) || [];
            }

            static getColorIdentity(card) {
                return card.color_identity || [];
            }
        }

        // Enhanced Firebase service
        class FirebaseService {
            static currentUser = null;
            static listeners = new Map();

            static async signInAnonymously() {
                try {
                    const result = await auth.signInAnonymously();
                    this.currentUser = result.user;
                    return result.user;
                } catch (error) {
                    console.error('Auth error:', error);
                    throw error;
                }
            }

            static generateRoomCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            static async createRoom(hostName, settings = {}) {
                if (!this.currentUser) await this.signInAnonymously();
                
                const roomCode = this.generateRoomCode();
                const room = {
                    id: roomCode,
                    host: hostName,
                    hostId: this.currentUser.uid,
                    settings: {
                        startingLife: settings.startingLife || 40,
                        maxPlayers: settings.maxPlayers || 4,
                        format: settings.format || 'commander',
                        allowSpectators: settings.allowSpectators || false,
                        ...settings
                    },
                    state: 'lobby',
                    players: {},
                    gameData: {
                        turn: 0,
                        currentPlayer: null,
                        phase: 'main',
                        stack: []
                    },
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    lastActivity: firebase.database.ServerValue.TIMESTAMP
                };

                // Add host as first player
                room.players[this.currentUser.uid] = {
                    id: this.currentUser.uid,
                    name: hostName,
                    isHost: true,
                    connected: true,
                    life: room.settings.startingLife,
                    commanderDamage: {},
                    position: 0,
                    commander: null,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                };

                await database.ref(`rooms/${roomCode}`).set(room);
                return roomCode;
            }

            static async joinRoom(roomCode, playerName) {
                if (!this.currentUser) await this.signInAnonymously();
                
                const roomRef = database.ref(`rooms/${roomCode}`);
                const snapshot = await roomRef.once('value');
                const room = snapshot.val();
                
                if (!room) throw new Error('Room not found');
                if (room.state !== 'lobby') throw new Error('Game already in progress');
                
                const playerCount = Object.keys(room.players || {}).length;
                if (playerCount >= room.settings.maxPlayers) throw new Error('Room is full');

                const newPlayer = {
                    id: this.currentUser.uid,
                    name: playerName,
                    isHost: false,
                    connected: true,
                    life: room.settings.startingLife,
                    commanderDamage: {},
                    position: playerCount,
                    commander: null,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                };

                await roomRef.child(`players/${this.currentUser.uid}`).set(newPlayer);
                await roomRef.child('lastActivity').set(firebase.database.ServerValue.TIMESTAMP);
                
                return room;
            }

            static async leaveRoom(roomCode) {
                if (!this.currentUser) return;
                
                const roomRef = database.ref(`rooms/${roomCode}`);
                await roomRef.child(`players/${this.currentUser.uid}`).remove();
                
                // Check if room is empty and clean up
                const snapshot = await roomRef.child('players').once('value');
                if (!snapshot.exists()) {
                    await roomRef.remove();
                }
            }

            static onRoomUpdate(roomCode, callback) {
                const roomRef = database.ref(`rooms/${roomCode}`);
                roomRef.on('value', snapshot => {
                    const room = snapshot.val();
                    callback(room);
                });

                return () => roomRef.off('value');
            }

            static async updatePlayerData(roomCode, updates) {
                if (!this.currentUser) return;
                
                const playerRef = database.ref(`rooms/${roomCode}/players/${this.currentUser.uid}`);
                await playerRef.update(updates);
            }

            static async updateGameData(roomCode, updates) {
                const gameRef = database.ref(`rooms/${roomCode}/gameData`);
                await gameRef.update(updates);
            }

            static async startGame(roomCode) {
                const roomRef = database.ref(`rooms/${roomCode}`);
                await roomRef.update({
                    state: 'playing',
                    'gameData/turn': 1,
                    'gameData/phase': 'main',
                    'gameData/currentPlayer': 0
                });
            }
        }

        // Main App Component
        const MTGCommanderGame = () => {
            const [gameState, setGameState] = useState('menu');
            const [connectionState, setConnectionState] = useState('offline');
            const [currentRoom, setCurrentRoom] = useState(null);
            const [roomCode, setRoomCode] = useState('');
            const [playerName, setPlayerName] = useState('');
            const [showJoin, setShowJoin] = useState(false);
            const [currentPlayer, setCurrentPlayer] = useState(null);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            // Initialize Firebase auth listener
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(user => {
                    if (user) {
                        setConnectionState('online');
                    } else {
                        setConnectionState('offline');
                    }
                });

                return unsubscribe;
            }, []);

            // Listen for room updates
            useEffect(() => {
                if (currentRoom && roomCode) {
                    const unsubscribe = FirebaseService.onRoomUpdate(roomCode, room => {
                        if (room) {
                            setCurrentRoom(room);
                            // Update current player info
                            if (FirebaseService.currentUser && room.players) {
                                setCurrentPlayer(room.players[FirebaseService.currentUser.uid]);
                            }
                        } else {
                            // Room was deleted
                            handleLeave();
                        }
                    });
                    return unsubscribe;
                }
            }, [currentRoom, roomCode]);

            const handleCreate = async () => {
                if (!playerName.trim()) {
                    setError('Please enter a player name');
                    return;
                }
                
                setLoading(true);
                setError('');
                setConnectionState('connecting');
                
                try {
                    const code = await FirebaseService.createRoom(playerName, {
                        startingLife: 40,
                        maxPlayers: 4,
                        format: 'commander'
                    });
                    
                    setRoomCode(code);
                    setConnectionState('online');
                    setGameState('lobby');
                } catch (err) {
                    setError(err.message);
                    setConnectionState('offline');
                } finally {
                    setLoading(false);
                }
            };

            const handleJoin = async () => {
                if (!playerName.trim()) {
                    setError('Please enter a player name');
                    return;
                }
                if (!roomCode.trim()) {
                    setError('Please enter a room code');
                    return;
                }
                
                setLoading(true);
                setError('');
                setConnectionState('connecting');
                
                try {
                    await FirebaseService.joinRoom(roomCode.toUpperCase(), playerName);
                    setRoomCode(roomCode.toUpperCase());
                    setConnectionState('online');
                    setGameState('lobby');
                    setShowJoin(false);
                } catch (err) {
                    setError(err.message);
                    setConnectionState('offline');
                } finally {
                    setLoading(false);
                }
            };

            const handleLeave = async () => {
                if (roomCode) {
                    await FirebaseService.leaveRoom(roomCode);
                }
                setCurrentRoom(null);
                setCurrentPlayer(null);
                setRoomCode('');
                setConnectionState('offline');
                setGameState('menu');
                setError('');
            };

            const handleStartGame = async () => {
                if (currentRoom && currentRoom.hostId === FirebaseService.currentUser?.uid) {
                    try {
                        await FirebaseService.startGame(roomCode);
                        setGameState('playing');
                    } catch (err) {
                        setError('Failed to start game');
                    }
                }
            };

            // Menu Component
            const MenuScreen = () => (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-8 relative overflow-hidden">
                    {/* Animated background elements */}
                    <div className="absolute inset-0 overflow-hidden">
                        <div className="absolute top-1/4 left-1/4 w-64 h-64 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse"></div>
                        <div className="absolute top-3/4 right-1/4 w-64 h-64 bg-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse" style={{animationDelay: '1s'}}></div>
                        <div className="absolute top-1/2 left-1/2 w-64 h-64 bg-indigo-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse" style={{animationDelay: '2s'}}></div>
                    </div>

                    {/* Connection Status */}
                    <div className="absolute top-4 right-4 z-10">
                        {connectionState === 'online' && (
                            <div className="flex items-center gap-2 text-green-400 bg-black/20 px-3 py-2 rounded-full backdrop-blur-sm">
                                <Wifi size={16}/> Online
                            </div>
                        )}
                        {connectionState === 'connecting' && (
                            <div className="flex items-center gap-2 text-yellow-400 bg-black/20 px-3 py-2 rounded-full backdrop-blur-sm animate-pulse">
                                <RefreshCw size={16} className="animate-spin"/> Connecting
                            </div>
                        )}
                        {connectionState === 'offline' && (
                            <div className="flex items-center gap-2 text-red-400 bg-black/20 px-3 py-2 rounded-full backdrop-blur-sm">
                                <WifiOff size={16}/> Offline
                            </div>
                        )}
                    </div>

                    <div className="relative z-10 flex flex-col items-center justify-center min-h-screen">
                        <div className="text-center mb-12">
                            <h1 className="text-7xl font-bold text-white mb-4 float">
                                ‚öîÔ∏è MTG Commander
                            </h1>
                            <p className="text-xl text-gray-300 mb-8">
                                Multiplayer Commander Life Tracker & Game Manager
                            </p>
                        </div>

                        <div className="glass-effect p-8 rounded-2xl max-w-md w-full">
                            <input
                                type="text"
                                placeholder="Enter your planeswalker name"
                                value={playerName}
                                onChange={e => {
                                    setPlayerName(e.target.value);
                                    setError('');
                                }}
                                className="w-full px-4 py-3 rounded-lg bg-black/30 text-white placeholder-gray-400 border border-gray-600 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 mb-6"
                                maxLength={20}
                            />

                            {error && (
                                <div className="mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-300 text-sm">
                                    {error}
                                </div>
                            )}

                            <div className="flex gap-4">
                                <button 
                                    onClick={handleCreate}
                                    disabled={!playerName.trim() || loading}
                                    className="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 card-hover"
                                >
                                    {loading ? <RefreshCw size={16} className="animate-spin mx-auto" /> : 'Create Room'}
                                </button>
                                <button 
                                    onClick={() => setShowJoin(true)}
                                    className="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition-all duration-200 card-hover"
                                >
                                    Join Room
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Join Room Modal */}
                    {showJoin && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="glass-effect p-6 rounded-2xl max-w-sm w-full mx-4">
                                <h3 className="text-2xl font-bold text-white mb-4 text-center">Join Game</h3>
                                <input
                                    type="text"
                                    placeholder="Enter room code (6 letters)"
                                    value={roomCode}
                                    onChange={e => {
                                        setRoomCode(e.target.value.toUpperCase());
                                        setError('');
                                    }}
                                    maxLength={6}
                                    className="w-full px-4 py-3 rounded-lg bg-black/30 text-white placeholder-gray-400 border border-gray-600 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 mb-4 text-center text-2xl font-mono tracking-widest"
                                />
                                
                                {error && (
                                    <div className="mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-300 text-sm">
                                        {error}
                                    </div>
                                )}

                                <div className="flex gap-3">
                                    <button 
                                        onClick={handleJoin}
                                        disabled={!playerName.trim() || !roomCode.trim() || loading}
                                        className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                    >
                                        {loading ? <RefreshCw size={16} className="animate-spin mx-auto" /> : 'Join'}
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setShowJoin(false);
                                            setError('');
                                            setRoomCode('');
                                        }}
                                        className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );

            // Lobby Component
            const LobbyScreen = () => {
                const players = currentRoom?.players ? Object.values(currentRoom.players) : [];
                const isHost = currentPlayer?.isHost || false;
                const canStart = players.length >= 2;

                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-900 to-blue-900 p-8">
                        <div className="max-w-4xl mx-auto">
                            {/* Header */}
                            <div className="glass-effect p-6 rounded-2xl mb-6">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <h2 className="text-3xl font-bold text-white mb-2">
                                            Game Lobby
                                        </h2>
                                        <div className="flex items-center gap-4">
                                            <div className="text-2xl font-mono text-yellow-400 bg-black/20 px-4 py-2 rounded-lg">
                                                {roomCode}
                                            </div>
                                            <button 
                                                onClick={() => navigator.clipboard.writeText(roomCode)}
                                                className="p-2 text-gray-400 hover:text-white transition-colors"
                                                title="Copy room code"
                                            >
                                                <Copy size={20} />
                                            </button>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={handleLeave}
                                        className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                                    >
                                        <LogOut size={16} />
                                        Leave
                                    </button>
                                </div>
                            </div>

                            {/* Players Grid */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                {Array.from({ length: currentRoom?.settings?.maxPlayers || 4 }).map((_, idx) => {
                                    const player = players[idx];
                                    return (
                                        <div 
                                            key={idx} 
                                            className={`glass-effect p-4 rounded-xl transition-all duration-300 ${
                                                player ? 'border-green-500/50' : 'border-gray-600/50'
                                            }`}
                                        >
                                            {player ? (
                                                <div className="text-center">
                                                    <div className="w-16 h-16 mx-auto mb-3 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full flex items-center justify-center">
                                                        <Users className="text-white" size={24} />
                                                    </div>
                                                    <h3 className="text-white font-semibold mb-1">
                                                        {player.name}
                                                    </h3>
                                                    {player.isHost && (
                                                        <div className="flex items-center justify-center gap-1 text-yellow-400 text-sm">
                                                            <Crown size={14} />
                                                            Host
                                                        </div>
                                                    )}
                                                    <div className={`text-sm mt-2 px-2 py-1 rounded ${
                                                        player.connected ? 'text-green-400 bg-green-500/20' : 'text-red-400 bg-red-500/20'
                                                    }`}>
                                                        {player.connected ? 'Connected' : 'Disconnected'}
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="text-center text-gray-400">
                                                    <div className="w-16 h-16 mx-auto mb-3 bg-gray-700 rounded-full flex items-center justify-center">
                                                        <Plus size={24} />
                                                    </div>
                                                    <p>Waiting for player...</p>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>

                            {/* Game Settings */}
                            <div className="glass-effect p-6 rounded-2xl mb-6">
                                <h3 className="text-xl font-bold text-white mb-4">Game Settings</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div>
                                        <div className="text-2xl font-bold text-green-400">
                                            {currentRoom?.settings?.startingLife || 40}
                                        </div>
                                        <div className="text-gray-400 text-sm">Starting Life</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold text-blue-400">
                                            {currentRoom?.settings?.maxPlayers || 4}
                                        </div>
                                        <div className="text-gray-400 text-sm">Max Players</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold text-purple-400 capitalize">
                                            {currentRoom?.settings?.format || 'Commander'}
                                        </div>
                                        <div className="text-gray-400 text-sm">Format</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold text-yellow-400">
                                            {players.length}
                                        </div>
                                        <div className="text-gray-400 text-sm">Players Ready</div>
                                    </div>
                                </div>
                            </div>

                            {/* Start Game Button */}
                            {isHost && (
                                <div className="text-center">
                                    <button
                                        onClick={handleStartGame}
                                        disabled={!canStart}
                                        className={`px-8 py-4 text-xl font-bold rounded-2xl transition-all duration-300 ${
                                            canStart
                                                ? 'bg-gradient-to-r from-green-600 to-emerald-600 text-white hover:from-green-700 hover:to-emerald-700 pulse-glow'
                                                : 'bg-gray-600 text-gray-400 cursor-not-allowed'
                                        }`}
                                    >
                                        <div className="flex items-center gap-3">
                                            <Play size={24} />
                                            {canStart ? 'Start Game' : `Need ${2 - players.length} more players`}
                                        </div>
                                    </button>
                                </div>
                            )}

                            {!isHost && (
                                <div className="text-center">
                                    <div className="text-gray-400 text-lg">
                                        Waiting for host to start the game...
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            // Game Component
            const GameScreen = () => {
                const players = currentRoom?.players ? Object.values(currentRoom.players) : [];
                const [selectedPlayer, setSelectedPlayer] = useState(null);
                const [commanderDamageMode, setCommanderDamageMode] = useState(false);
                const [diceResult, setDiceResult] = useState(null);

                const updateLife = async (playerId, change) => {
                    if (!currentRoom || !FirebaseService.currentUser) return;
                    
                    const player = currentRoom.players[playerId];
                    if (!player) return;
                    
                    const newLife = Math.max(0, player.life + change);
                    await FirebaseService.updatePlayerData(roomCode, { life: newLife });
                };

                const updateCommanderDamage = async (targetId, sourceId, damage) => {
                    if (!currentRoom || !FirebaseService.currentUser) return;
                    
                    const updates = {};
                    updates[`commanderDamage.${sourceId}`] = 
                        (currentRoom.players[targetId].commanderDamage?.[sourceId] || 0) + damage;
                    
                    await database.ref(`rooms/${roomCode}/players/${targetId}`).update(updates);
                };

                const rollDice = () => {
                    const result = Math.floor(Math.random() * 20) + 1;
                    setDiceResult(result);
                    setTimeout(() => setDiceResult(null), 3000);
                };

                const resetGame = async () => {
                    if (!currentRoom?.hostId === FirebaseService.currentUser?.uid) return;
                    
                    const updates = {};
                    Object.keys(currentRoom.players).forEach(playerId => {
                        updates[`players/${playerId}/life`] = currentRoom.settings.startingLife;
                        updates[`players/${playerId}/commanderDamage`] = {};
                    });
                    
                    await database.ref(`rooms/${roomCode}`).update(updates);
                };

                // Player component
                const PlayerZone = ({ player, position }) => {
                    const isCurrentUser = player.id === FirebaseService.currentUser?.uid;
                    const commanderDamage = Object.entries(player.commanderDamage || {});
                    const totalCommanderDamage = commanderDamage.reduce((sum, [_, damage]) => sum + damage, 0);
                    
                    const positionClasses = [
                        'order-1', // Top left
                        'order-3', // Top right  
                        'order-7', // Bottom left
                        'order-9'  // Bottom right
                    ];

                    return (
                        <div className={`player-zone ${positionClasses[position]} ${isCurrentUser ? 'ring-2 ring-blue-500' : ''}`}>
                            <div className="text-center mb-4">
                                <h3 className="text-white font-bold text-lg mb-1">{player.name}</h3>
                                {player.isHost && (
                                    <div className="flex items-center justify-center gap-1 text-yellow-400 text-sm">
                                        <Crown size={14} />
                                        Host
                                    </div>
                                )}
                            </div>

                            {/* Life Counter */}
                            <div className="life-counter mb-4">
                                <div className="relative z-10">
                                    <div className="text-4xl font-bold text-white mb-2">
                                        {player.life}
                                    </div>
                                    <div className="text-sm text-white/80">Life</div>
                                </div>
                            </div>

                            {/* Life adjustment buttons */}
                            <div className="grid grid-cols-4 gap-2 mb-4">
                                <button
                                    onClick={() => updateLife(player.id, -5)}
                                    className="p-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
                                >
                                    -5
                                </button>
                                <button
                                    onClick={() => updateLife(player.id, -1)}
                                    className="p-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                                >
                                    -1
                                </button>
                                <button
                                    onClick={() => updateLife(player.id, 1)}
                                    className="p-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors"
                                >
                                    +1
                                </button>
                                <button
                                    onClick={() => updateLife(player.id, 5)}
                                    className="p-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                                >
                                    +5
                                </button>
                            </div>

                            {/* Commander Damage */}
                            {commanderDamage.length > 0 && (
                                <div className="space-y-1">
                                    <div className="text-xs text-gray-400 mb-2">Commander Damage:</div>
                                    {commanderDamage.map(([sourceId, damage]) => {
                                        const source = currentRoom.players[sourceId];
                                        return (
                                            <div key={sourceId} className="commander-damage text-xs">
                                                {source?.name}: {damage}
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {/* Commander Damage buttons */}
                            <div className="mt-2">
                                <button
                                    onClick={() => {
                                        setSelectedPlayer(player.id);
                                        setCommanderDamageMode(true);
                                    }}
                                    className="w-full p-2 bg-orange-600 text-white rounded text-sm hover:bg-orange-700 transition-colors"
                                >
                                    Commander Damage
                                </button>
                            </div>
                        </div>
                    );
                };

                return (
                    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900">
                        <div className="game-board">
                            {/* Players */}
                            {players.slice(0, 4).map((player, idx) => (
                                <PlayerZone key={player.id} player={player} position={idx} />
                            ))}

                            {/* Central Game Area */}
                            <div className="central-zone order-5">
                                <div className="text-center mb-6">
                                    <h2 className="text-3xl font-bold text-white mb-2">Commander Game</h2>
                                    <div className="text-gray-400">Room: {roomCode}</div>
                                </div>

                                {/* Game Controls */}
                                <div className="flex flex-wrap justify-center gap-4 mb-6">
                                    <button
                                        onClick={rollDice}
                                        className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        <Dice6 size={20} />
                                        Roll d20
                                    </button>
                                    
                                    {currentPlayer?.isHost && (
                                        <button
                                            onClick={resetGame}
                                            className="flex items-center gap-2 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors"
                                        >
                                            <RotateCcw size={20} />
                                            Reset Game
                                        </button>
                                    )}
                                    
                                    <button
                                        onClick={handleLeave}
                                        className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                                    >
                                        <LogOut size={20} />
                                        Leave Game
                                    </button>
                                </div>

                                {/* Dice Result */}
                                {diceResult && (
                                    <div className="glass-effect p-6 rounded-2xl mb-4 text-center">
                                        <div className="text-4xl font-bold text-yellow-400 mb-2">üé≤</div>
                                        <div className="text-3xl font-bold text-white">{diceResult}</div>
                                        <div className="text-gray-400">d20 Roll</div>
                                    </div>
                                )}

                                {/* Game Stats */}
                                <div className="glass-effect p-4 rounded-xl">
                                    <div className="grid grid-cols-2 gap-4 text-center text-sm">
                                        <div>
                                            <div className="text-2xl font-bold text-green-400">
                                                {Math.max(...players.map(p => p.life))}
                                            </div>
                                            <div className="text-gray-400">Highest Life</div>
                                        </div>
                                        <div>
                                            <div className="text-2xl font-bold text-red-400">
                                                {Math.min(...players.map(p => p.life))}
                                            </div>
                                            <div className="text-gray-400">Lowest Life</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Commander Damage Modal */}
                        {commanderDamageMode && selectedPlayer && (
                            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm">
                                <div className="glass-effect p-6 rounded-2xl max-w-sm w-full mx-4">
                                    <h3 className="text-xl font-bold text-white mb-4 text-center">
                                        Commander Damage to {currentRoom.players[selectedPlayer]?.name}
                                    </h3>
                                    
                                    <div className="space-y-3">
                                        {players.filter(p => p.id !== selectedPlayer).map(player => (
                                            <div key={player.id} className="flex items-center justify-between">
                                                <span className="text-white">{player.name}</span>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => updateCommanderDamage(selectedPlayer, player.id, 1)}
                                                        className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700"
                                                    >
                                                        +1
                                                    </button>
                                                    <button
                                                        onClick={() => updateCommanderDamage(selectedPlayer, player.id, 2)}
                                                        className="px-3 py-1 bg-red-700 text-white rounded hover:bg-red-800"
                                                    >
                                                        +2
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    <button
                                        onClick={() => {
                                            setCommanderDamageMode(false);
                                            setSelectedPlayer(null);
                                        }}
                                        className="w-full mt-4 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // Main render
            if (gameState === 'menu') return <MenuScreen />;
            if (gameState === 'lobby') return <LobbyScreen />;
            if (gameState === 'playing') return <GameScreen />;
            
            return null;
        };

        // Render the app
        ReactDOM.render(<MTGCommanderGame />, document.getElementById('root'));
    </script>
</body>
</html>
